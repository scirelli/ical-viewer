<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iCalendar (.ics) Event Viewer</title>
    <!-- 1. ical.js library for parsing iCalendar files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.5.0/ical.js"></script>
    
    <!-- 2. Custom Vanilla CSS (Replaces Tailwind) -->
    <style>
        /* --- Base Styles --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #F3F4F6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 72rem; /* 1152px */
            margin-left: auto;
            margin-right: auto;
            padding: 1rem;
        }

        /* --- Header & File Input --- */
        .page-header {
            background-color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .page-header h1 {
            font-size: 1.875rem;
            font-weight: 700;
            color: #1F2937;
            margin: 0;
        }
        .page-header p {
            color: #4B5563;
            margin-top: 0.5rem;
        }
        .file-input-container {
            margin-top: 1.5rem;
        }
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            cursor: pointer;
        }
        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        .file-input-button {
            cursor: pointer;
            background-color: #2563EB;
            color: #ffffff;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        .file-input-button:hover {
            background-color: #1D4ED8;
        }
        
        /* --- Message Area --- */
        #messageArea {
            text-align: center;
            padding: 1rem;
        }
        .message-info {
            font-size: 1.125rem;
            color: #2563EB;
        }
        .message-error {
            font-size: 1.125rem;
            color: #DC2626;
        }
        .message-error-details {
            font-size: 0.875rem;
            color: #6B7280;
            margin-top: 0.5rem;
        }

        /* --- NEW: Group Headers --- */
        .year-header {
            font-size: 2.25rem; /* 36px */
            font-weight: 800;
            color: #111827;
            margin-top: 3rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid #D1D5DB;
            /* Span full grid width */
            grid-column: 1 / -1; 
        }
        .month-header {
            font-size: 1.875rem; /* 30px */
            font-weight: 700;
            color: #1F2937;
            margin-top: 2rem;
            margin-bottom: 0.5rem;
            /* Span full grid width */
            grid-column: 1 / -1; 
        }
        .day-header {
            font-size: 1.25rem; /* 20px */
            font-weight: 600;
            color: #374151;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #E5E7EB;
            /* Span full grid width */
            grid-column: 1 / -1; 
        }

        /* --- Event List & Cards --- */
        #eventList {
            display: grid;
            grid-template-columns: repeat(1, minmax(0, 1fr));
            gap: 1.5rem;
        }
        /* --- UPDATED: Use <details> tag --- */
        .event-card {
            display: block; /* Required for <details> */
            background-color: #ffffff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 0.5rem;
            padding: 1.5rem;
            transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* --- UPDATED: Use <summary> tag --- */
        .event-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            gap: 1rem; /* Add gap between elements */
            list-style: none; /* Hide default <summary> marker */
        }
        .event-card-header::-webkit-details-marker {
            display: none; /* Hide default <summary> marker */
        }

        /* --- NEW: Time Label --- */
        .time-label {
            font-size: 0.875rem; /* 14px */
            font-weight: 600;
            color: #4B5563;
            flex-shrink: 0; /* Don't shrink */
            white-space: nowrap;
        }
        .event-summary {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1D4ED8;
            margin: 0;
            /* Allow header to shrink but title to wrap */
            min-width: 0; 
            word-wrap: break-word;
            flex-grow: 1; /* Allow summary to take remaining space */
        }
        .toggle-icon {
            transition: transform 300ms cubic-bezier(0.4, 0, 0.2, 1);
            /* Prevent icon from shrinking */
            flex-shrink: 0;
            margin-left: 0.5rem;
        }
        .toggle-icon svg {
            height: 1.25rem;
            width: 1.25rem;
            color: #6B7280;
        }
        
        /* --- NEW: Rotate icon when <details> is open --- */
        .event-card[open] .toggle-icon {
            transform: rotate(180deg);
        }

        /* --- Collapsible Details --- */
        .event-details {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #E5E7EB;
        }
        
        /* --- NEW: Description List Styles --- */
        .detail-list {
            display: grid;
            grid-template-columns: auto 1fr; /* Label and Value */
            gap: 0.75rem 1rem; /* row-gap column-gap */
            font-size: 0.875rem;
        }
        .detail-list dt {
            font-weight: 500;
            color: #111827;
            grid-column: 1;
        }
        .detail-list dd {
            color: #374151;
            word-wrap: break-word;
            margin: 0; /* Reset browser default */
            grid-column: 2;
        }

        .recurring-badge {
            display: inline-block;
            background-color: #DBEAFE;
            color: #1E40AF;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.125rem 0.625rem;
            border-radius: 9999px;
            margin-top: 1rem;
        }

        /* --- Utility Classes (REMOVED .hidden) --- */
        .rotate-180 {
            transform: rotate(180deg);
        }

        /* --- Responsive Grid --- */
        @media (min-width: 768px) {
            .container {
                padding: 2rem;
            }
            #eventList {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
        @media (min-width: 1024px) {
            #eventList {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body>

    <div class="container">
        
        <header class="page-header">
            <h1>iCalendar (.ics) Event Viewer</h1>
            <p>Upload your .ics file to see all the events listed as cards below.</p>
            
            <!-- Styled File Input -->
            <div class="file-input-container">
                <label for="icsFile" class="file-input-wrapper">
                    <span class="file-input-button">
                        Select .ics File
                    </span>
                    <input type="file" id="icsFile" accept=".ics,text/calendar">
                </label>
            </div>
        </header>

        <!-- Message Area for loading or errors -->
        <div id="messageArea" class="text-center p-4"></div>

        <!-- Event List Container -->
        <div id="eventList">
            <!-- Event cards will be dynamically inserted here -->
        </div>

    </div>
 <script>
            if(!Array.prototype.chunk){
                Array.prototype.chunk = async function chunk(func, chunkSize=500, index=0) {
                    if(index >= this.length) return Promise.resolve(true);
                    if(chunkSize <= 0) chunkSize = 1;
                    if(index <= 0) index = 0;
                    for(var csz=0; csz<chunkSize && index<this.length; index++, csz++){ // Use var for csz
                        func(this[index]);
                    }
                    return new Promise(resolve=>{
                        // Use requestAnimationFrame to yield to the main thread
                        requestAnimationFrame(() => {
                            resolve(this.chunk(func, chunkSize, index));
                        });
                    });
                }
            }
        </script>
    <script>
        document.getElementById('icsFile').addEventListener('change', handleFileSelect, false);

        // --- Keep track of current headers ---
        let currentYear = null;
        let currentMonth = null;

        async function handleFileSelect(event) { // <-- This function is async
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            const eventList = document.getElementById('eventList');
            const messageArea = document.getElementById('messageArea');

            // Clear previous results
            eventList.innerHTML = '';
            messageArea.innerHTML = '<p class="message-info">Parsing your calendar...</p>';

            // --- Reset headers ---
            currentYear = null;
            currentMonth = null;

            // --- FIX: Make the onload function async ---
            reader.onload = async function(e) { // <-- Made this function async
                const fileContent = e.target.result;

                try {
                    // 1. Parse the iCalendar data using ical.js
                    const jcalData = ICAL.parse(fileContent);
                    
                    // 2. Wrap the jcal data in a component
                    const vcalendar = new ICAL.Component(jcalData);
                    
                    // 3. Get all 'vevent' (event) subcomponents
                    const vevents = vcalendar.getAllSubcomponents('vevent');

                    // --- Update message, but don't clear it yet ---
                    messageArea.innerHTML = '<p class="message-info">Processing events...</p>'; // Changed message

                    if (vevents.length === 0) {
                        messageArea.innerHTML = '<p class="message-error">No events found in this file.</p>';
                        return;
                    }

                    // 4. --- NEW: Process all events into a flat list of occurrences ---
                    let allEventInstances = [];
                    const iterLimit = 500; // Safety limit for recurring events
                    
                    // --- FIX: More robust time window calculation ---
                    const now = ICAL.Time.now();
                    if (!now) {
                        throw new Error("Fatal: ICAL.Time.now() returned a falsy value.");
                    }

                    // --- FIX: addDuration appears to modify in-place and return undefined ---
                    // --- Clone 'now' first, then call addDuration on the clone. ---
                    const iterStart = now.clone();
                    iterStart.addDuration(new ICAL.Duration({ days: -365 }));
                    
                    const iterEnd = now.clone();
                    iterEnd.addDuration(new ICAL.Duration({ days: 365 }));


                    // --- FIX: Add guard clauses to ensure ical.js returned valid times ---
                    if (!iterStart || !iterEnd) {
                        // --- More explicit logging ---
                        console.error("Fatal: Could not calculate time window.", { 
                            now: now ? now.toString() : "undefined", 
                            iterStart: iterStart ? iterStart.toString() : "undefined", 
                            iterEnd: iterEnd ? iterEnd.toString() : "undefined" 
                        });
                        throw new Error("Fatal: Could not calculate time window for recurring events.");
                    }

                    for (const vevent of vevents) {
                        const event = new ICAL.Event(vevent);
                        
                        if (event.isRecurring()) {
                            const iter = event.iterator(iterStart);
                            let next;
                            let i = 0;
                            
                            while (i < iterLimit && (next = iter.next())) {
                                if (next.compare(iterEnd) > 0) {
                                    break; // Stop iterating if we're past 1 year from now
                                }
                                const details = event.getOccurrenceDetails(next);
                                allEventInstances.push(...expandMultiDayEvent(details));
                                i++;
                            }
                        } else {
                            // Single event
                            allEventInstances.push(...expandMultiDayEvent(event));
                        }
                    }

                    // 5. --- NEW: Group the instances ---
                    messageArea.innerHTML = '<p class="message-info">Grouping events...</p>';
                    const groupedByYear = groupBy(allEventInstances, e => e.renderDate.getFullYear());

                    // 6. --- NEW: Create sorted day-by-day tasks ---
                    let dayTasks = [];
                    const sortedYears = Object.keys(groupedByYear).sort((a, b) => a - b);
        
                    for (const year of sortedYears) {
                        const groupedByMonth = groupBy(groupedByYear[year], e => e.renderDate.getMonth());
                        const sortedMonths = Object.keys(groupedByMonth).sort((a, b) => a - b);
                        
                        for (const month of sortedMonths) {
                            const groupedByDay = groupBy(groupedByMonth[month], e => e.renderDate.getDate());
                            const sortedDays = Object.keys(groupedByDay).sort((a, b) => a - b);
                            
                            for (const day of sortedDays) {
                                const eventsForDay = groupedByDay[day];
                                
                                // Sort events for the day: All-day first, then by start time
                                eventsForDay.sort((a, b) => {
                                    if (a.isAllDay && !b.isAllDay) return -1;
                                    if (!a.isAllDay && b.isAllDay) return 1;
                                    return a.startDate.getTime() - b.startDate.getTime();
                                });
                                
                                dayTasks.push({
                                    year: year,
                                    month: month, // 0-11
                                    day: day,     // 1-31
                                    date: eventsForDay[0].renderDate, // For formatting
                                    events: eventsForDay
                                });
                            }
                        }
                    }

                    // 7. --- NEW: Process tasks in chunks ---
                    messageArea.innerHTML = `<p class="message-info">Rendering ${allEventInstances.length} event instances...</p>`;
                    
                    // This 'await' is now valid because reader.onload is async
                    await dayTasks.chunk(renderDayGroup, 1); // Render 1 day at a time
                    
                    messageArea.innerHTML = ''; // All done

                } catch (err) {
                    console.error('Error parsing iCalendar file:', err);
                    messageArea.innerHTML = `<p class="message-error">Error: Could not parse the file. Please ensure it is a valid .ics file.</p><p class="message-error-details">${err.message}</p>`;
                }
            };

            // Read the file as text
            reader.readAsText(file);
        }

        /**
         * --- NEW HELPER ---
         * Expands a single event or occurrence into multiple instances, one for each day it spans.
         */
        function expandMultiDayEvent(eventOrDetails) {
            const instances = [];
            const s = eventOrDetails.startDate.toJSDate();
            const e = eventOrDetails.endDate.toJSDate();
            const isAllDay = eventOrDetails.startDate.isDate;
            
            // Get component for organizer
            const component = eventOrDetails.item ? eventOrDetails.item.component : eventOrDetails.component;
            
            // Clone to avoid modifying the original
            let currentDay = new Date(s.getFullYear(), s.getMonth(), s.getDate()); 

            while (currentDay < e) {
                instances.push({
                    renderDate: new Date(currentDay), // The day this card belongs to
                    startDate: s,
                    endDate: e,
                    isAllDay: isAllDay,
                    summary: eventOrDetails.summary || 'No Title',
                    location: eventOrDetails.location,
                    description: eventOrDetails.description,
                    organizer: getOrganizer(component),
                    isRecurring: eventOrDetails.isRecurring ? eventOrDetails.isRecurring() : (eventOrDetails.item ? eventOrDetails.item.isRecurring() : false)
                });
                
                // Move to the next day
                currentDay.setDate(currentDay.getDate() + 1);
            }
            return instances;
        }

        /**
         * --- NEW HELPER ---
         * Gets the organizer name from a component.
         */
        function getOrganizer(component) {
            if (!component) return null;
            const organizerProp = component.getFirstProperty('organizer');
            let organizerName = null;
            if (organizerProp) {
                organizerName = organizerProp.getParameter('cn') || organizerProp.getValue().toString();
                organizerName = organizerName.replace('MAILTO:', '');
            }
            return organizerName;
        }

        /**
         * --- NEW HELPER ---
         * Groups an array of objects by a key.
         */
        function groupBy(list, keyGetter) {
            const map = new Map();
            list.forEach((item) => {
                const key = keyGetter(item);
                const collection = map.get(key);
                if (!collection) {
                    map.set(key, [item]);
                } else {
                    collection.push(item);
                }
            });
            // Convert Map to plain object for easier key sorting
            return Object.fromEntries(map);
        }

        /**
         * --- NEW FUNCTION ---
         * Renders a single day's worth of events, including headers.
         * Called by the chunker.
         */
        function renderDayGroup(dayTask) {
            const eventListElement = document.getElementById('eventList');
            if (!eventListElement) return;

            // Check if we need to add Year/Month headers
            if (dayTask.year !== currentYear) {
                currentYear = dayTask.year;
                currentMonth = null; // Reset month
                const yearHeader = document.createElement('h2');
                yearHeader.className = 'year-header';
                yearHeader.textContent = currentYear;
                eventListElement.appendChild(yearHeader);
            }
            
            if (dayTask.month !== currentMonth) {
                currentMonth = dayTask.month;
                const monthHeader = document.createElement('h3');
                monthHeader.className = 'month-header';
                monthHeader.textContent = dayTask.date.toLocaleString('default', { month: 'long' });
                eventListElement.appendChild(monthHeader);
            }
            
            // Add Day header
            const dayHeader = document.createElement('h4');
            dayHeader.className = 'day-header';
            dayHeader.textContent = `${dayTask.date.toLocaleString('default', { weekday: 'long' })}, ${dayTask.day}`;
            eventListElement.appendChild(dayHeader);
            
            // Add cards for this day
            for (const eventData of dayTask.events) {
                appendEventCard(eventData); // Pass the processed data
            }
        }


        /**
         * Creates a single event card and appends it to the event list.
         * This function is now called by renderDayGroup.
         */
        function appendEventCard(eventData) { // <-- Parameter changed to eventData
            const eventListElement = document.getElementById('eventList');
            if (!eventListElement) return;

            // --- Event data is already processed ---
            
            // --- UPDATED: Card creation using <details> and <summary> ---
            const card = document.createElement('details'); // <details> tag
            card.className = 'event-card';

            const header = document.createElement('summary'); // <summary> tag
            header.className = 'event-card-header';
            
            // --- NEW: Add Time Label ---
            const timeLabel = document.createElement('span');
            timeLabel.className = 'time-label';
            if (eventData.isAllDay) {
                timeLabel.textContent = 'All Day';
            } else {
                const timeFormat = { hour: 'numeric', minute: '2-digit' };
                const start = eventData.startDate.toLocaleTimeString('default', timeFormat);
                const end = eventData.endDate.toLocaleTimeString('default', timeFormat);
                timeLabel.textContent = `${start} - ${end}`;
            }
            header.appendChild(timeLabel);

            const summary = document.createElement('h3');
            summary.className = 'event-summary';
            summary.textContent = eventData.summary; // Use pre-processed summary
            header.appendChild(summary);

            const toggleIcon = document.createElement('span');
            toggleIcon.className = 'toggle-icon';
            toggleIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`;
            header.appendChild(toggleIcon);
            
            card.appendChild(header);

            const detailsContainer = document.createElement('div');
            detailsContainer.className = 'event-details'; // No 'hidden' class
            
            // --- NEW: Use <dl> for details ---
            const dl = document.createElement('dl');
            dl.className = 'detail-list';

            const start = eventData.startDate ? eventData.startDate.toLocaleString() : 'N/A';
            dl.appendChild(createDetailTerm('Start'));
            dl.appendChild(createDetailDescription(start));
            
            const end = eventData.endDate ? eventData.endDate.toLocaleString() : 'N/A';
            dl.appendChild(createDetailTerm('End'));
            dl.appendChild(createDetailDescription(end));

            dl.appendChild(createDetailTerm('Location'));
            dl.appendChild(createDetailDescription(eventData.location));
            
            dl.appendChild(createDetailTerm('Description'));
            dl.appendChild(createDetailDescription(eventData.description, true)); // true for description
            
            dl.appendChild(createDetailTerm('Organizer'));
            dl.appendChild(createDetailDescription(eventData.organizer));

            detailsContainer.appendChild(dl); // Add the list

            if (eventData.isRecurring) {
                const recurringBadge = document.createElement('span');
                recurringBadge.className = 'recurring-badge';
                recurringBadge.textContent = 'Recurring Event';
                detailsContainer.appendChild(recurringBadge); // Append after <dl>
            }

            card.appendChild(detailsContainer);
            
            // --- REMOVED: Click listener is no longer needed ---
            
            eventListElement.appendChild(card);
        }

        /**
         * --- NEW HELPER ---
         * Creates a <dt> element.
         */
        function createDetailTerm(label) {
            const dt = document.createElement('dt');
            dt.textContent = label;
            return dt;
        }

        /**
         * --- NEW HELPER ---
         * Creates a <dd> element.
         * Safely handles newlines for descriptions.
         */
        function createDetailDescription(value, isDescription = false) {
            const dd = document.createElement('dd');
            if (value) {
                if (isDescription) {
                    // Set textContent first to sanitize, then replace newlines
                    dd.textContent = value;
                    dd.innerHTML = dd.innerHTML.replace(/\n/g, '<br>');
                } else {
                    dd.textContent = value;
                }
            } else {
                dd.textContent = 'N/A';
            }
            return dd;
        }

    </script>
</body>
</html>
