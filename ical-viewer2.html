<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iCalendar (.ics) Event Viewer</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.5.0/ical.js"></script>
    <script src="https://scirelli.github.io/jslib/extras-array.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #F3F4F6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <ical-loader></ical-loader>
    <ical-viewer></ical-viewer>

    <script>
        /**
         * Helper function to create a styled detail element (e.g., "Label: Value")
         */
        function createDetailElement(label, value) {
            if (!value) {
                return document.createDocumentFragment();
            }

            const p = document.createElement('p');
            p.className = 'detail-item';

            const strong = document.createElement('strong');
            strong.className = 'detail-label';
            strong.textContent = `${label}: `;

            const text = document.createTextNode(value);

            p.appendChild(strong);
            p.appendChild(text);

            return p;
        }

        /**
         * Creates a single event card and appends it to the event list.
         * This function is called by the Array.prototype.chunk method.
         */
        function appendEventCard(event) {
            const eventListElement = document.getElementById('eventList');
            if (!eventListElement) return;

            const startDate = event.startDate ? event.startDate.toJSDate() : null;
            const card = document.createElement('div');
            card.className = 'event-card';

            const header = document.createElement('div');
            header.className = 'event-card-header';

            const summary = document.createElement('h3');
            summary.className = 'event-summary';
            summary.textContent = event.summary || 'No Title';
            header.appendChild(summary);

            const toggleIcon = document.createElement('span');
            toggleIcon.className = 'toggle-icon';
            toggleIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`;
            header.appendChild(toggleIcon);

            card.appendChild(header);

            const detailsContainer = document.createElement('div');
            detailsContainer.className = 'event-details hidden';

            const start = startDate ? startDate.toLocaleString() : 'N/A';
            detailsContainer.appendChild(createDetailElement('Start', start));

            const end = event.endDate ? event.endDate.toJSDate().toLocaleString() : 'N/A';
            detailsContainer.appendChild(createDetailElement('End', end));

            detailsContainer.appendChild(createDetailElement('Location', event.location));
            detailsContainer.appendChild(createDetailElement('Description', event.description));

            const organizerProp = vevent.getFirstProperty('organizer'); // <-- Use vevent
            let organizerName = null;
            if (organizerProp) {
                organizerName = organizerProp.getParameter('cn') || organizerProp.getValue().toString();
                organizerName = organizerName.replace('MAILTO:', '');
            }
            detailsContainer.appendChild(createDetailElement('Organizer', organizerName));

            if (event.isRecurring()) {
                const recurringBadge = document.createElement('span');
                recurringBadge.className = 'recurring-badge';
                recurringBadge.textContent = 'Recurring Event';
                detailsContainer.appendChild(recurringBadge);
            }

            card.appendChild(detailsContainer);

            header.addEventListener('click', () => {
                detailsContainer.classList.toggle('hidden');
                toggleIcon.classList.toggle('rotate-180');
            });

            eventListElement.appendChild(card);
        }
    </script>
    <script >
        (function icalLoader() {
            const TAG_NAME = 'ical-loader';
            customElements.define(
                TAG_NAME,
                class iCalLoader extends HTMLElement {
                    static TAG_NAME = TAG_NAME;

                    static get observedAttributes() {
                        return [];
                    }

                    static __registerElement() {
                        customElements.define(TAG_NAME, iCalLoader);
                    }

                    #messageAreaElm;

                    constructor() {
                        super();
                        this.attachShadow({ mode: 'open' });
                        this._initDom(this.shadowRoot);
                        this._attachEventListeners();
                    }

                    attributeChangedCallback(name, oldValue, newValue) {
                        if(oldValue === newValue) return;
                        console.debug('Attribute changed', name, oldValue, newValue);
                        switch(name) {
                        default:
                            console.error('Unknown attribute');
                        }
                    }

                    render() {
                        //const clone2 = template.content.cloneNode(true)
                        let template = document.createElement('div'),
                            styles = document.createElement('style');
                        template.innerHTML = iCalLoader.html;
                        styles.textContent = iCalLoader.css;
                        return [styles, ...Array.prototype.slice.call(template.childNodes).filter(n => !(n instanceof Text))];
                    }

                    _initDom(rootElem) {
                        rootElem.append(...this.render());
                        this.#messageAreaElm = this.shadowRoot.getElementById('messageArea');
                        return this;
                    }

                    _attachEventListeners() {
                        this.shadowRoot.getElementById('icsFile').addEventListener('change', this._handleFileSelect.bind(this), false);
                        return this;
                    }

                    async _handleFileSelect(event) {
                        const file = event.target.files[0];
                        if (!file) return;

                        const reader = new FileReader();

                        this._setMessage('<p class="message-info">Parsing your calendar...</p>');

                        reader.addEventListener('load', (e) => {
                            let iCalEvents = this._parseEvents(e.target.result);

                            if (iCalEvents.length === 0) {
                                this._setMessage(`
                                    <p class="message-error">No events found in this file or</p>
                                    <p class="message-error">Could not parse the file. Please ensure it is a valid .ics file.</p>
                                `);
                                return;
                            }

                            this._setMessage(`<p class="message-info">Rendering ${iCalEvents.length} events...</p>`);

                            iCalEvents.chunk(iCalEvent => {
                                 this._fireiCalEvent(iCalEvent);
                            }, 50).then(() =>{
                                this._setMessage('');
                            });
                        });

                        reader.readAsText(file);
                    }

                    _fireiCalEvent(e) {
                        document.body.dispatchEvent(new CustomEvent('ical-event', {detail: {icalEvent:e}}));
                        return this;
                    }

                    _setMessage(msg) {
                        this.#messageAreaElm.innerHTML = msg;
                        return this;
                    }

                    _addMessage(msg) {
                        this.#messageAreaElm.innerHTML += msg;
                        return this;
                    }

                    _parseEvents(file) {
                        let events = []
                        try {
                            events = new ICAL.Component(ICAL.parse(file)).getAllSubcomponents('vevent').map(ve => {
                                return new ICAL.Event(ve);
                            });
                        } catch (err) {
                            console.error('Error parsing iCalendar file:', err);
                            events = [];
                        }

                        return events;
                    }

                    static css = `
                        .container {
                            max-width: 72rem; /* 1152px */
                            margin-left: auto;
                            margin-right: auto;
                            padding: 1rem;
                        }

                        .page-header {
                            background-color: #ffffff;
                            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                            border-radius: 0.5rem;
                            padding: 1.5rem;
                            margin-bottom: 2rem;
                        }
                        .page-header h1 {
                            font-size: 1.875rem;
                            font-weight: 700;
                            color: #1F2937;
                            margin: 0;
                        }
                        .page-header p {
                            color: #4B5563;
                            margin-top: 0.5rem;
                        }
                        .file-input-container {
                            margin-top: 1.5rem;
                        }
                        .file-input-wrapper {
                            position: relative;
                            overflow: hidden;
                            display: inline-block;
                            cursor: pointer;
                        }
                        .file-input-wrapper input[type=file] {
                            font-size: 100px;
                            position: absolute;
                            left: 0;
                            top: 0;
                            opacity: 0;
                            cursor: pointer;
                        }
                        .file-input-button {
                            cursor: pointer;
                            background-color: #2563EB;
                            color: #ffffff;
                            font-weight: 600;
                            padding: 0.5rem 1rem;
                            border-radius: 0.5rem;
                            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
                            transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
                        }
                        .file-input-button:hover {
                            background-color: #1D4ED8;
                        }

                        #messageArea {
                            text-align: center;
                            padding: 1rem;
                        }
                        .message-info {
                            font-size: 1.125rem;
                            color: #2563EB;
                        }
                        .message-error {
                            font-size: 1.125rem;
                            color: #DC2626;
                        }
                        .message-error-details {
                            font-size: 0.875rem;
                            color: #6B7280;
                            margin-top: 0.5rem;
                        }
                        /* --- Utility Classes --- */
                        .hidden {
                            display: none;
                        }
                        /* --- Responsive Grid --- */
                        @media (min-width: 768px) {
                            .container {
                                padding: 2rem;
                            }
                        }
                    `;

                    static html = `
                    <div class="container">
                        <header class="page-header">
                            <h1>iCalendar (.ics) Event Viewer</h1>
                            <p>Upload your .ics file to see all the events listed as cards below.</p>

                            <!-- Styled File Input -->
                            <div class="file-input-container">
                                <label for="icsFile" class="file-input-wrapper">
                                    <span class="file-input-button">
                                        Select .ics File
                                    </span>
                                    <input type="file" id="icsFile" accept=".ics,text/calendar">
                                </label>
                            </div>
                        </header>

                        <!-- Message Area for loading or errors -->
                        <div id="messageArea" class="text-center p-4"></div>
                    </div>
                    `;
                }
            );
            //export default customElement.get(TAG_NAME);
        })();
    </script>
    <script >
        (function icalViewer() {
            const TAG_NAME = 'ical-viewer';
            customElements.define(
                TAG_NAME,
                class iCalViewer extends HTMLElement {
                    static TAG_NAME = TAG_NAME;

                    static get observedAttributes() {
                        return [
                            'sort',
                            'data-sort'
                        ];
                    }

                    static __registerElement() {
                        customElements.define(TAG_NAME, iCalViewer);
                    }

                    constructor() {
                        super();
                        this.attachShadow({ mode: 'open' });
                        this._initDom(this.shadowRoot);
                        this._attachEventListeners();
                    }

                    attributeChangedCallback(name, oldValue, newValue) {
                        if(oldValue === newValue) return;
                        console.debug('Attribute changed', name, oldValue, newValue);
                        switch(name) {
                            case 'sort':
                            case 'data-sort':
                                break;
                        default:
                            console.error('Unknown attribute');
                        }
                    }

                    render() {
                        //const clone2 = template.content.cloneNode(true)
                        let template = document.createElement('div'),
                            styles = document.createElement('style');
                        template.innerHTML = iCalViewer.html;
                        styles.textContent = iCalViewer.css;
                        return [styles, ...Array.prototype.slice.call(template.childNodes).filter(n => !(n instanceof Text))];
                    }

                    _initDom(rootElem) {
                        rootElem.append(...this.render());
                        return this;
                    }

                    _attachEventListeners() {
                        this.addEventListener('add-item', this._onAddItem.bind(this));
                        document.body.addEventListener('ical-event', this._onAddItem.bind(this));
                        return this;
                    }

                    _onAddItem(evt) {
                        this._addItem(evt.detail.icalEvent);
                    }

                    _addItem(itm) {
                        console.debug(itm);
                    }

                    static css = `
                        .container {
                            max-width: 72rem; /* 1152px */
                            margin-left: auto;
                            margin-right: auto;
                            padding: 1rem;
                        }

                        #eventList {
                            display: grid;
                            grid-template-columns: repeat(1, minmax(0, 1fr));
                            gap: 1.5rem;
                        }
                        /* --- Utility Classes --- */
                        .hidden {
                            display: none;
                        }
                        /* --- Responsive Grid --- */
                        @media (min-width: 768px) {
                            .container {
                                padding: 2rem;
                            }
                            #eventList {
                                grid-template-columns: repeat(2, minmax(0, 1fr));
                            }
                        }
                        @media (min-width: 1024px) {
                            #eventList {
                                grid-template-columns: repeat(3, minmax(0, 1fr));
                            }
                        }
                    `;
                    static html = `
                    <div class="container">
                        <div id="eventList"></div>
                    </div>

                    <template id="templ-event-card">
                        <div class="event-card">
                            <div class="event-card-header">
                                <details>
                                    <summary><slot name="event-summary-slot">No Summary</slot></summary>
                                    <div class="event-content">
                                        <dl></dl>
                                    </div>
                                </details>
                            </div>
                            <span class="recurring-badge hidden">Recurring Event</span>
                        </div>
                    </template>
                    `;
                }
            );
            //export default customElement.get(TAG_NAME);
        })();
    </script>
    <script >
        (function icalEvent() {
            const TAG_NAME = 'ical-event';
            customElements.define(
                TAG_NAME,
                class iCalEvent extends HTMLElement {
                    static TAG_NAME = TAG_NAME;

                    static get observedAttributes() {
                        return [];
                    }

                    static __registerElement() {
                        customElements.define(TAG_NAME, iCalEvent);
                    }

                    constructor() {
                        super();
                        this.attachShadow({ mode: 'open' });
                        this._initDom(this.shadowRoot);
                        this._attachEventListeners();
                    }

                    attributeChangedCallback(name, oldValue, newValue) {
                        if(oldValue === newValue) return;
                        console.debug('Attribute changed', name, oldValue, newValue);
                        switch(name) {
                        default:
                            console.error('Unknown attribute');
                        }
                    }

                    render() {
                        //const clone2 = template.content.cloneNode(true)
                        let template = document.createElement('div'),
                            styles = document.createElement('style');
                        template.innerHTML = iCalEvent.html;
                        styles.textContent = iCalEvent.css;
                        return [styles, ...Array.prototype.slice.call(template.childNodes).filter(n => !(n instanceof Text))];
                    }

                    setData(calEvent) {
                    }

                    _initDom(rootElem) {
                        rootElem.append(...this.render());
                        return this;
                    }

                    _attachEventListeners() {
                        return this;
                    }

                    static css = `
                        .event-card {
                            background-color: #ffffff;
                            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                            border-radius: 0.5rem;
                            padding: 1.5rem;
                            transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
                        }
                        .event-card-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            cursor: pointer;
                        }
                        .event-summary {
                            font-size: 1.25rem;
                            font-weight: 700;
                            color: #1D4ED8;
                            margin: 0;
                            /* Allow header to shrink but title to wrap */
                            min-width: 0;
                            word-wrap: break-word;
                        }
                        .toggle-icon {
                            transition: transform 300ms cubic-bezier(0.4, 0, 0.2, 1);
                            /* Prevent icon from shrinking */
                            flex-shrink: 0;
                            margin-left: 0.5rem;
                        }
                        .toggle-icon svg {
                            height: 1.25rem;
                            width: 1.25rem;
                            color: #6B7280;
                        }

                        /* --- Collapsible Details --- */
                        .event-details {
                            margin-top: 1rem;
                            padding-top: 1rem;
                            border-top: 1px solid #E5E7EB;
                        }
                        .detail-item {
                            font-size: 0.875rem;
                            color: #374151;
                            margin-top: 0.5rem;
                            word-wrap: break-word;
                        }
                        .detail-label {
                            font-weight: 500;
                            color: #111827;
                        }
                        .recurring-badge {
                            display: inline-block;
                            background-color: #DBEAFE;
                            color: #1E40AF;
                            font-size: 0.75rem;
                            font-weight: 600;
                            padding: 0.125rem 0.625rem;
                            border-radius: 9999px;
                            margin-top: 1rem;
                        }

                        /* --- Utility Classes --- */
                        .hidden {
                            display: none;
                        }
                        .rotate-180 {
                            transform: rotate(180deg);
                        }
                    `;
                    static html = `
                    <template id="templ-event-card">
                        <div class="event-card">
                            <div class="event-card-header">
                                <details>
                                    <summary><slot name="event-summary-slot">No Summary</slot></summary>
                                    <div class="event-content">
                                        <dl></dl>
                                    </div>
                                </details>
                            </div>
                            <span class="recurring-badge hidden">Recurring Event</span>
                        </div>
                    </template>
                    `;
                }
            );
            //export default customElement.get(TAG_NAME);
        })();
    </script>

</body>
</html>
