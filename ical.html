<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>iCalendar (.ics) Event Viewer</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.5.0/ical.min.js"></script>
        <style>
            .file-input-wrapper {
                position: relative;
                overflow: hidden;
                display: inline-block;
                cursor: pointer;
            }
            .file-input-wrapper input[type=file] {
                font-size: 100px;
                position: absolute;
                left: 0;
                top: 0;
                opacity: 0;
                cursor: pointer;
            }
            .file-input-button {
                cursor: pointer;
            }
        </style>
    </head>
    <body class="bg-gray-100 font-sans antialiased">
        <div class="container mx-auto p-4 md:p-8 max-w-6xl">
            <header class="bg-white shadow-md rounded-lg p-6 mb-8">
                <h1 class="text-3xl font-bold text-gray-800">iCalendar (.ics) Event Viewer</h1>
                <p class="text-gray-600 mt-2">Upload your .ics file to see all the events listed as cards below.</p>

                <!-- Styled File Input -->
                <div class="mt-6">
                    <label for="icsFile" class="file-input-wrapper">
                        <span class="file-input-button bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-blue-700 transition-colors duration-300">
                            Select .ics File
                        </span>
                        <input type="file" id="icsFile" accept=".ics,text/calendar">
                    </label>
                </div>
            </header>

            <!-- Message Area for loading or errors -->
            <div id="messageArea" class="text-center p-4"></div>

            <!-- Event List Container -->
            <div id="eventList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Event cards will be dynamically inserted here -->
            </div>
        </div>

        <script>
            if(!Array.prototype.chunk){
                Array.prototype.chunk = async function chunk(func, chunkSize=500, index=0) {
                    if(index >= this.length) return Promise.resolve(true);
                    if(chunkSize <= 0) chunkSize = 1;
                    if(index <= 0) index = 0;
                    for(csz=0; csz<chunkSize && index<this.length; index++, csz++){
                        func(this[index]);
                    }
                    return new Promise(resolve=>{
                        resolve(this.chunk(func, chunkSize, index));
                    });
                }
            }
        </script>

        <script>
            document.getElementById('icsFile').addEventListener('change', handleFileSelect, false);

            function handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                const eventList = document.getElementById('eventList');
                const messageArea = document.getElementById('messageArea');

                eventList.innerHTML = '';
                messageArea.innerHTML = '<p class="text-lg text-blue-600">Parsing your calendar...</p>';

                reader.onload = function(e) {
                    const fileContent = e.target.result;

                    try {
                        const vcalendar = new ICAL.Component(ICAL.parse(fileContent));
                        const vevents = vcalendar.getAllSubcomponents('vevent');

                        messageArea.innerHTML = ''; // Clear "Parsing..." message
                        if (vevents.length === 0) {
                            messageArea.innerHTML = '<p class="text-lg text-red-600">No events found in this file.</p>';
                            return;
                        }

                        vevents.chunk(function(vevent) {
                            const event = new ICAL.Event(vevent);

                            const card = document.createElement('div');
                            card.className = 'bg-white shadow-lg rounded-lg p-6 transform hover:scale-105 transition-transform duration-300 ease-in-out';

                            // --- Event Summary (Title) ---
                            const summary = document.createElement('h3');
                            summary.className = 'text-xl font-bold text-blue-700 mb-2';
                            summary.textContent = event.summary || 'No Title';
                            card.appendChild(summary);

                            // --- Start and End Dates ---
                            const start = event.startDate ? event.startDate.toJSDate().toLocaleString() : 'N/A';
                            card.appendChild(createDetailElement('Start', start));

                            const end = event.endDate ? event.endDate.toJSDate().toLocaleString() : 'N/A';
                            card.appendChild(createDetailElement('End', end));

                            // --- Location ---
                            card.appendChild(createDetailElement('Location', event.location));

                            // --- Description ---
                            card.appendChild(createDetailElement('Description', event.description));

                            // --- Organizer ---
                            // FIX: Get the ICAL.Property object first using getFirstProperty
                            const organizerProp = event.component.getFirstProperty('organizer');
                            let organizerName = null;
                            if (organizerProp) {
                                // Try to get the Common Name (CN) parameter first
                                // FIX: Use getValue().toString() to safely get the string value
                                organizerName = organizerProp.getParameter('cn') || organizerProp.getValue().toString();
                                // Clean up 'MAILTO:' prefix if it exists
                                organizerName = organizerName.replace('MAILTO:', '');
                            }
                            card.appendChild(createDetailElement('Organizer', organizerName));

                            // --- Recurring Event Badge ---
                            if (event.isRecurring()) {
                                const recurringBadge = document.createElement('span');
                                recurringBadge.className = 'inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full mt-4';
                                recurringBadge.textContent = 'Recurring Event';
                                card.appendChild(recurringBadge);
                            }

                            eventList.appendChild(card);
                        }).catch(e=>{
                            console.error('Error parsing iCalendar file:', err);
                            messageArea.innerHTML = `<p class="text-lg text-red-600">Error: Could not parse the file. Please ensure it is a valid .ics file.</p><p class="text-sm text-gray-500 mt-2">${err.message}</p>`;
                        });
                    } catch (err) {
                        console.error('Error parsing iCalendar file:', err);
                        messageArea.innerHTML = `<p class="text-lg text-red-600">Error: Could not parse the file. Please ensure it is a valid .ics file.</p><p class="text-sm text-gray-500 mt-2">${err.message}</p>`;
                    }
                };

                reader.readAsText(file);
            }

            /**
             * Helper function to create a styled detail element (e.g., "Label: Value")
             * Safely handles null or undefined values.
             */
            function createDetailElement(label, value) {
                if (!value) {
                    return document.createDocumentFragment();
                }

                const p = document.createElement('p');
                p.className = 'text-sm text-gray-700 mt-2 break-words';

                const strong = document.createElement('strong');
                strong.className = 'font-medium text-gray-900';
                strong.textContent = `${label}: `;

                const text = document.createTextNode(value);

                p.appendChild(strong);
                p.appendChild(text);

                return p;
            }
        </script>
    </body>
</html>
