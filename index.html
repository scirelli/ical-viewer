<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>iCalendar (.ics) Event Viewer</title>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.5.0/ical.js"></script>
        <script src="https://scirelli.github.io/jslib/extras-array.js"></script>

        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
                background-color: #F3F4F6;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                margin: 0;
                padding: 0;
            }
        </style>
    </head>
    <body>
        <ical-loader></ical-loader>
        <ical-viewer></ical-viewer>

        <script type="module" src="ical-loader.mjs"></script>

        <script >
            (function icalViewer() {
                const TAG_NAME = 'ical-viewer';
                customElements.define(
                    TAG_NAME,
                    class iCalViewer extends HTMLElement {
                        static TAG_NAME = TAG_NAME;

                        static get observedAttributes() {
                            return [
                                'sort',
                                'data-sort'
                            ];
                        }

                        static __registerElement() {
                            customElements.define(TAG_NAME, iCalViewer);
                        }

                        #eventCardTemplElm;
                        #eventListElm;

                        constructor() {
                            super();
                            this.attachShadow({ mode: 'open' });
                            this._initDom(this.shadowRoot);
                            this._attachEventListeners();
                        }

                        attributeChangedCallback(name, oldValue, newValue) {
                            if(oldValue === newValue) return;
                            console.debug('Attribute changed', name, oldValue, newValue);
                            switch(name) {
                                case 'sort':
                                case 'data-sort':
                                    break;
                            default:
                                console.error('Unknown attribute');
                            }
                        }

                        render() {
                            let template = document.createElement('div'),
                                styles = document.createElement('style');
                            template.innerHTML = iCalViewer.html;
                            styles.textContent = iCalViewer.css;
                            return [styles, ...Array.prototype.slice.call(template.childNodes).filter(n => !(n instanceof Text))];
                        }

                        _initDom(rootElem) {
                            rootElem.append(...this.render());
                            this.#eventCardTemplElm = this.shadowRoot.querySelector('#templ-event-card');
                            this.#eventListElm = this.shadowRoot.querySelector('#eventList');
                            return this;
                        }

                        _attachEventListeners() {
                            this.addEventListener('add-item', this._onAddItem.bind(this));
                            document.body.addEventListener('ical-event', this._onAddItem.bind(this));
                            return this;
                        }

                        _onAddItem(evt) {
                            this._addItem(evt.detail.icalEvent);
                        }

                        _addItem(iCalEvent) {
                            if (!iCalEvent) return;
                            console.debug(iCalEvent);

                            const eventCardElem = this._createEventCardElm(),
                                data = this._get_iCalEventData(iCalEvent),
                                dlElm = eventCardElem.querySelector('dl'),
                                summaryElm = eventCardElem.querySelector('summary');

                            summaryElm.innerText = data.summary;
                            if(data.recurring) {
                                const rElm = document.createElement('span');
                                rElm.classList.add('recurring-badge');
                                rElm.innerText = 'Recurring Event';
                                summaryElm.append(rElm);
                            }
                            dlElm.append(...createDescListItem('Start', data.start.toLocaleString()));
                            dlElm.append(...createDescListItem('End', data.end.toLocaleString()));
                            if(data.location) dlElm.append(...createDescListItem('Location', data.location));
                            if(data.description) dlElm.append(...createDescListItem('Description', data.description));

                            this.#eventListElm.append(eventCardElem);
                            function createDescListItem(label, value) {
                                const dt = document.createElement('dt'),
                                    dd = document.createElement('dd');
                                dt.innerText = label;
                                dt.classList.add('capitalize');
                                dd.innerText = value;
                                return [dt,dd];
                            }
                        }

                        _get_iCalEventData(iCalEvent) {
                            return {
                                start: iCalEvent.startDate ? iCalEvent.startDate.toJSDate() : new Date(0),
                                end: iCalEvent.endDate ? iCalEvent.endDate.toJSDate() : new Date(0),
                                summary: iCalEvent.summary || 'No Title',
                                location: iCalEvent.location || '',
                                description: iCalEvent.description || '',
                                recurring: iCalEvent.isRecurring ? iCalEvent.isRecurring() : false,
                            };
                        }

                        _createEventCardElm() {
                            return this.#eventCardTemplElm.content.cloneNode(true);
                        }

                        static css = `
                            .container {
                                max-width: 72rem; /* 1152px */
                                margin-left: auto;
                                margin-right: auto;
                                padding: 1rem;
                            }

                            #eventList {
                                display: grid;
                                grid-template-columns: repeat(1, minmax(0, 1fr));
                                gap: 1.5rem;
                            }

                            .event-card {
                                display: block;
                                background-color: #ffffff;
                                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                                border-radius: 0.5rem;
                                padding: 1.5rem;
                                transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
                            }
                            .event-card-header {
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                cursor: pointer;
                                gap: 1rem;
                                list-style: none;
                            }
                            .event-card-header::-webkit-details-marker {
                                display: none;
                            }
                            .time-label {
                                font-size: 0.875rem;
                                font-weight: 600;
                                color: #4B5563;
                                flex-shrink: 0;
                                white-space: nowrap;
                            }

                            .event-summary {
                                font-size: 1.25rem;
                                font-weight: 700;
                                color: #1D4ED8;
                                margin: 0;
                                min-width: 0;
                                word-wrap: break-word;
                                flex-grow: 1;
                            }

                            .recurring-badge {
                                display: inline-block;
                                background-color: #DBEAFE;
                                color: #1E40AF;
                                font-size: 0.75rem;
                                font-weight: 600;
                                padding: 0.125rem 0.625rem;
                                border-radius: 9999px;
                                margin-top: 1rem;
                            }

                            dt::after {
                              content: ": ";
                            }

                            /* --- Utility Classes --- */
                            .hidden {
                                display: none;
                            }
                            .capitalize {
                                text-transform: capitalize;
                            }
                            /* --- Responsive Grid --- */
                            @media (min-width: 768px) {
                                .container {
                                    padding: 2rem;
                                }
                                #eventList {
                                    grid-template-columns: repeat(2, minmax(0, 1fr));
                                }
                            }
                            @media (min-width: 1024px) {
                                #eventList {
                                    grid-template-columns: repeat(3, minmax(0, 1fr));
                                }
                            }
                        `;

                        static html = `
                        <div class="jump-controls hidden">
                            <div class="jump-group">
                                <label>Year
                                    <select>
                                        <option value="">Select Year</option>
                                    </select>
                                </label>
                            </div>
                            <div class="jump-group">
                                <label>Month
                                    <select disabled="">
                                        <option value="">Select Month</option>
                                    </select>
                                </label>
                            </div>
                            <button class="jump-button">Jump</button>
                        </div>

                        <div class="container">
                            <div id="eventList"></div>
                        </div>

                        <template id="templ-event-card">
                            <div class="event-card">
                                <details>
                                    <summary  class="event-summary"></summary>
                                    <dl></dl>
                                </details>
                            </div>
                        </template>
                        `;
                    }
                );
                //export default customElement.get(TAG_NAME);
            })();
        </script>
    </body>
</html>
